name: Build and Release

on:
  push:
    tags:
      - "v*" # Trigger on any tag starting with "v" (like v1.0.0)

permissions:
  contents: write # Needed to create a GitHub Release

jobs:
  build_and_release:
    name: Build app and publish release
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build App with Xcode
        run: |
          xcodebuild clean build \
            -project typesteps.xcodeproj \
            -scheme typesteps \
            -configuration Release \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES \
            SYMROOT=$(pwd)/build

      - name: Zip the built App
        run: |
          cd build/Release
          zip -r typesteps.zip typesteps.app

      - name: Calculate SHA256 Checksum
        id: shasum
        run: |
          cd build/Release
          echo "sha=$(shasum -a 256 typesteps.zip | awk '{ print $1 }')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/Release/typesteps.zip
          draft: false
          prerelease: false
          body: |
            ## Automated Release for TypeSteps
            
            **SHA256 Checksum:**
            `${{ steps.shasum.outputs.sha }}`
            
            _The Homebrew Tap has been automatically updated!_
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew Tap
        run: |
          # The GitHub tag (e.g., v1.0.0)
          TAG_NAME=${GITHUB_REF_NAME}
          VERSION=${TAG_NAME#v} # Removes the 'v' (e.g., 1.0.0)
          
          # Clone the tap repository
          git clone https://x-access-token:${{ secrets.TAP_GITHUB_TOKEN }}@github.com/FALAK097/homebrew-typesteps.git
          cd homebrew-typesteps
          
          # Update the version and sha256 in the Ruby cask file
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Casks/typesteps.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"${{ steps.shasum.outputs.sha }}\"/" Casks/typesteps.rb
          
          # Commit and push the changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/typesteps.rb
          git commit -m "Bump TypeSteps to version ${VERSION}"
          git push
